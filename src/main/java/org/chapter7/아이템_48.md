## 아이템_48

### 스트림 병렬화는 주의해서 적용하라.

동시성 프로그래밍을 할 때는 안전성과 응답 가능 상태를 유지하기 위해 애써야 하는데, 

병렬 스트림 파이프라인 프로그래밍에서도 다를 바 없다.


- 스트림의 속도를 높이고 싶어 스트림 파이프라인의 parallel() 을 호출하게 되었을 때 성능이 낮아지거나 문제가 되는 경우가 있다.

왜? 이런 일이 일어 날까? 이런 경우에 스트림 라이브러리가 이 파이프라인을 병렬화 하는 방법을 찾지 못했기 때문이다.

환경이 아무리 좋더라도 ***데이더 소스가 Stream.iterate 거나 중간 연산으로 limit 를 쓰면 파이프라인 병렬화로는 성능 개선을 기대 할 수 없다***

따라서, 스트림 파이프라인을 마구잡이로 병렬화하면 안된다. 성능이 오히려 끔찍하게 나빠질 수도 있다.

- 대체로, ***스트림의 소스가 ArrayList, HashMap, HashSet, ConcurrentHashMap 의 인스턴스거나 배열, int 범위, long 범위일 때 병렬화의 효과가 가장 좋다.***

위의 자료구조들은 모두 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어서 일을 다수의 스레드에 분배하기에 좋다는 특징이 있다.

***스트림을 잘못 병렬화하면 (응답 불가를 포함해) 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다.***



---

## 마무리

계산도 올바로 수행하고 성능도 빨라질 거라는 확신 없이는 스트림 파이프라인 병렬화는 시도조차 하지 말라.

스트림을 잘못 병렬화하면 프로그램을 오작동하게 하거나 성능을 급격히 떨어뜨린다.

병렬화하는 편이 낫다고 믿더라도, 수정 후의 코드가 여전히 정확한지 확인하고 운영 환경과 유사한 조건에서 수행해보며 성능지표를 유심히 관찰하자.


