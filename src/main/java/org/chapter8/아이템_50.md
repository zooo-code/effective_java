## 아이템_50
### 적시에 방어적 복사본을 만들라

자바는 안전한 언어다. 

네이티브 메서드를 사용하지 않으니 C, C++ 같이 안전하지 않은 언어에서 흔히 보는 버퍼 오버런, 배열 오버런, 와일드 포인터 같은 메모리 충돌 오류에서 안전하다.

자바로 작성한 클래스는 시스템의 다른 부분에서 무슨 짓을 하든 그 불변식이 지켜진다.

---

하지만, 아무리 자바라 해도 다른 클래스로 부터의 침범을 아무런 노력 없이 다 막을 수 있는 건 아니다.

그러니 ***클라이언트가 여러분의 불변식을 깨뜨리려 혈안이 되어 있다고 가정하고 방어적 프로그래밍을 해야한다.***


어떤 객체든 그 객체의 허락 없이는 외부에서 내부를 수정하는 일은 불가능하다.

하지만 주의를 기울이지 않으면 자기도 모르게 내부를 수정하도록 허럭하는 경우가 생긴다.

```java
import java.util.Date;

public final class Period {
    private final Date start;
    private final Date end;

    public Period(Date start, Date end){
        if (start.compareTo(end) > 0)
            throw new IllegalArgumentException(
                    start +"가" + end + "보다 늦다."
            );
    }
    
    public Date start(){
        return start;
    }
    
    public Date end(){
        return end;
    }
    
}
```
얼핏 보면 불변으로 보이지만, Date가 가변이라는 사실을 이용하면 어렵지 않게 불변을 깨뜨릴수 있다.

***Date 는 낡은 API 이니 새로운 코드를 작성할 때는 더 이상 사용하면 안된다.***

하지만 앞으로 쓰지 않는다고 이 문제에서 해방 되는 것은 아니다.

외부의 공격으로부터 Period 인스턴스의 내부를 보호하려면 ***생성자에서 받은 가변 매개변수 각각을 방어적으로 복사해야한다.***

매개변수의 유효성을 검사하기 전에 방어적 복사본을 만들고, 이복사본으로 유효성을 검사한 점에 주목하자.

---

## 마무리

클래스가 클라이언트로부터 받는 혹은 클라이언트로 반환하는 구성요소가 가변이라면 그 요소는 반드시 방어벅으로 복사해야한다.

복사 비용이 너무 크거나 클라이언트가 그 요소를 잘못 수정할 일이 없음을 신뢰한다면 방어적 복사를 수행하는 대신 해당 구성 요소를 수정했을 때의 책임이

클라이언트에 있음을 문서에 명시하도록 하자.







### 참조

네이티브 메서드(Native method):

네이티브 메서드란 특정 프로그래밍 언어(일반적으로는 C나 C++ 등)로 작성된 함수나 라이브러리를 다른 프로그래밍 언어에서 직접 호출할 수 있는 기능을 말합니다. 예를 들어, Java에서는 JNI(Java Native Interface)를 사용하여 C나 C++로 작성된 네이티브 메서드를 호출할 수 있습니다. 이렇게 호출되는 메서드는 자바 가상 머신(JVM) 밖에서 실행되며, 일반적으로 하드웨어와 직접 상호작용하거나 시스템 레벨의 작업을 수행하는 데 사용됩니다.

버퍼 오버런(Buffer overrun):

버퍼 오버런은 프로그램이 할당된 메모리 영역을 벗어나 데이터를 쓰는 오류입니다. 예를 들어, 배열의 인덱스를 벗어난 위치에 값을 쓰거나 읽는 경우 발생할 수 있습니다. 이러한 오류는 일반적으로 프로그램이 다른 데이터나 코드 영역을 덮어쓰거나 조작할 수 있어 보안 취약점으로 이어질 수 있습니다.

배열 오버런(Array overrun):

배열 오버런은 버퍼 오버런의 한 유형으로, 배열에 할당된 메모리 영역을 벗어나 데이터를 쓰는 오류를 의미합니다. 일반적으로 인덱스가 배열의 범위를 벗어나는 경우 발생합니다.

와일드 포인터(Wild pointer):

와일드 포인터는 프로그램이 적절한 메모리 주소를 가리키지 않는 포인터를 사용하는 오류를 의미합니다. 이로 인해 예기치 않은 동작이 발생할 수 있습니다. 일반적으로 할당되지 않은 메모리 영역이나 이미 해제된 메모리 영역을 가리키는 포인터를 사용하는 경우와 관련이 있습니다. 이러한 오류는 메모리 누수나 프로그램의 불안정성을 초래할 수 있습니다.



`방어적 복사 `

방어적 복사(Defensive Copying)란 프로그래밍에서 데이터를 복사하여 안전하게 다루는 방법을 의미합니다.
주로 객체의 상태를 변경하는 작업을 수행할 때 사용되며, 
다중 스레드 환경이나 외부에서의 악의적인 접근에 대한 방어 메커니즘으로 활용됩니다.

방어적 복사는 주로 두 가지 상황에서 사용됩니다:

1. 객체의 불변성(Immutability): 객체를 변경할 때, 
원본 객체를 직접 변경하지 않고 해당 객체의 복사본을 만들어서 작업을 수행합니다. 
이는 객체의 불변성을 유지하고 원본 객체의 무결성을 보호하는 데 사용됩니다. 
예를 들어, Java에서는 String 클래스가 불변 클래스이며, 문자열을 변경할 때마다 새로운 문자열 객체가 생성됩니다.

2. 동시성(Concurrency): 다중 스레드 환경에서 공유되는 데이터를 안전하게 다루기 위해 사용됩니다. 여러 스레드가 동시에 접근할 때 데이터의 일관성을 보장하기 위해, 데이터를 변경하기 전에 해당 데이터를 복사하여 새로운 복사본에서 작업을 수행합니다. 이를 통해 다른 스레드가 원본 데이터에 접근하여 변경하는 것을 방지할 수 있습니다.

방어적 복사는 주로 불변 객체를 생성하거나, 변경 가능한 객체를 변경하지 않고 안전하게 다루기 위해 사용됩니다. 이를 통해 프로그램의 안전성과 안정성을 높일 수 있습니다.